name: Build and Deploy Docs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y portaudio19-dev python3-pyaudio
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx-rtd-theme
        pip install -e .
        
    - name: Prepare docs directory
      run: |
        mkdir -p docs/source docs/build/html
        
    - name: Setup documentation files
      run: |
        # Create basic index.rst
        echo "Welcome to DataVerse ChatBot Documentation" > docs/source/index.rst
        echo "==========================================" >> docs/source/index.rst
        echo "" >> docs/source/index.rst
        echo ".. toctree::" >> docs/source/index.rst
        echo "   :maxdepth: 2" >> docs/source/index.rst
        echo "   :caption: Contents:" >> docs/source/index.rst
        echo "" >> docs/source/index.rst
        echo "Module Documentation" >> docs/source/index.rst
        echo "-------------------" >> docs/source/index.rst
        echo "" >> docs/source/index.rst
        echo "* **main.py** - Main application entry point" >> docs/source/index.rst
        echo "* **tg_bot.py** - Telegram bot implementation" >> docs/source/index.rst
        echo "* **whatsapp_bot.py** - WhatsApp bot implementation" >> docs/source/index.rst
        echo "* **gradio_ui.py** - Gradio web interface" >> docs/source/index.rst
        echo "" >> docs/source/index.rst
        echo "Packages" >> docs/source/index.rst
        echo "--------" >> docs/source/index.rst
        echo "" >> docs/source/index.rst
        echo "* **chatbot** - Core chatbot functionality" >> docs/source/index.rst
        echo "* **chatbot.rag** - RAG implementation modules" >> docs/source/index.rst
        echo "* **chatbot.embeddings** - Embedding modules" >> docs/source/index.rst
        echo "* **chatbot.utils** - Utility functions" >> docs/source/index.rst
        echo "* **web** - Web application implementations" >> docs/source/index.rst
        echo "" >> docs/source/index.rst
        echo "Indices and tables" >> docs/source/index.rst
        echo "==================" >> docs/source/index.rst
        echo "" >> docs/source/index.rst
        echo "* :ref:\`genindex\`" >> docs/source/index.rst
        echo "* :ref:\`search\`" >> docs/source/index.rst
        
        # Create conf.py
        echo "project = 'DataVerse ChatBot'" > docs/source/conf.py
        echo "copyright = '2025, Ali Elneklawy'" >> docs/source/conf.py
        echo "author = 'Ali Elneklawy'" >> docs/source/conf.py
        echo "release = '0.1'" >> docs/source/conf.py
        echo "" >> docs/source/conf.py
        echo "extensions = ['sphinx.ext.autodoc', 'sphinx.ext.viewcode']" >> docs/source/conf.py
        echo "templates_path = ['_templates']" >> docs/source/conf.py
        echo "exclude_patterns = ['_build', 'Thumbs.db', '.DS_Store', '**/__pycache__']" >> docs/source/conf.py
        echo "html_theme = 'sphinx_rtd_theme'" >> docs/source/conf.py
        
    - name: Build simple documentation
      run: |
        cd docs
        mkdir -p source/_static
        
        # Create a .nojekyll file
        touch build/html/.nojekyll
        
        # Build documentation
        sphinx-build -b html source build/html
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.event_name != 'pull_request'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/build/html
        force_orphan: true
